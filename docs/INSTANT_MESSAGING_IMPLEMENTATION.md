[{"Purpose": "Provides a clean interface for subscribing to message updates following Clean Architecture principles.\n\n---\n\n### 2. ChatRepositoryImpl\n\n**Location:** `lib/data/repositories/chat_repository_impl.dart`\n\n#### getMessagesStream()\n\n```dart\n@override\nStream<Either<Failure", "room": "roomId');\n\n  // Return existing stream if already created\n  if (_messageStreams.containsKey(roomId)) {\n    _logger.d('Returning existing stream for room: $roomId');\n    return _messageStreams[roomId]!.stream;"}, {"m.room.message') {\n              final message = _parseMatrixEvent(event, roomId);\n              if (message != null) {\n                _logger.d(": "essage stream: New message for room $roomId: ${message.id"}, {"error": "error);\n          controller.add(Left(ServerFailure(message: error.toString())));"}, {"error": "e);\n      controller.add(Left(ServerFailure(message: 'Failed to create stream: $e')));"}, {"room": "roomId');\n    controller.add(Left(ServerFailure(message: 'Matrix client not initialized')));"}, ["roomId] = controller;\n  return controller.stream;\n}\n```\n\n#### getTypingUsers()\n\n```dart\n@override\nStream<Either<Failure, List<String>>> getTypingUsers(String roomId) {\n  _logger.d('Creating typing stream for room: $roomId');\n\n  if (_typingStreams.containsKey(roomId)) {\n    return _typingStreams[roomId]!.stream;\n  }\n\n  final controller = StreamController<Either<Failure, List<String>>>.broadcast();\n\n  if (_matrixClientService.isInitialized) {\n    try {\n      final client = _matrixClientService.client;\n      final syncStream = client.syncController.stream;\n\n      final subscription = syncStream.listen(\n        (syncData) {\n          final roomSync = syncData.rooms[roomId];\n          if (roomSync == null) return;\n\n          for (final event in roomSync.ephemeral) {\n            if (event.type == 'm.typing') {\n              final userIds = event.content['user_ids'] as List? ?? [];\n              controller.add(Right(userIds.cast<String>()));\n            }\n          }\n        },\n        onError: (error) {\n          _logger.e('Error in typing stream for room $roomId', error: error);\n          controller.add(Left(ServerFailure(message: error.toString())));\n        },\n        onDone: () {\n          _logger.d('Typing stream for room $roomId closed');\n        },\n      );\n\n      controller.onCancel = () {\n        subscription.cancel();\n        _typingStreams.remove(roomId);\n      };\n    } catch (e) {\n      _logger.e('Failed to create typing stream for room $roomId', error: e);\n      controller.add(Left(ServerFailure(message: 'Failed to create stream')));\n    }\n  } else {\n    _logger.w('Matrix client not initialized, cannot create typing stream for room: $roomId');\n    controller.add(Left(ServerFailure(message: 'Matrix client not initialized')));\n  }\n\n  _typingStreams[roomId] = controller;\n  return controller.stream;\n}\n```\n\n**Key Features:**\n- Broadcast streams support multiple listeners\n- Stream reuse (returns existing stream for same room)\n- Automatic cleanup on cancellation\n- Error handling with Either pattern\n- Parses Matrix events to domain entities\n\n---\n\n### 3. ChatBloc Integration\n\n**Location:** `lib/presentation/chat/bloc/chat_bloc.dart`\n\n```dart\n@injectable\nclass ChatBloc extends Bloc<ChatEvent, ChatState> {\n  ChatBloc(\n    // ... other dependencies\n    this._subscribeToMessagesUseCase,\n    this._logger,\n  ) : super(const ChatInitial()) {\n    // ... event handlers\n    on<SubscribeToMessages>(_onSubscribeToMessages);\n  }\n\n  StreamSubscription<Either<Failure, MessageEntity>>? _messageSubscription;\n\n  Future<void> _onSubscribeToMessages(\n    SubscribeToMessages event,\n    Emitter<ChatState> emit,\n  ) async {\n    // Load initial messages\n    add(LoadMessages(roomId: event.roomId));\n\n    // Subscribe to real-time stream\n    final stream = _subscribeToMessagesUseCase(roomId: event.roomId);\n\n    _messageSubscription = stream.listen(\n      (result) {\n        result.fold(\n          (failure) {\n            _logger.e('Error in message stream: ${failure.message}');\n            // Optionally emit error state\n          },\n          (message) {\n            _logger.d('Received new message: ${message.id}');\n            \n            // Get current messages and add new one\n            final currentState = state;\n            final List<MessageEntity> currentMessages = currentState is ChatLoaded\n                ? currentState.messages\n                : [];\n            \n            // Update state with new message\n            emit(ChatLoaded(messages: [...currentMessages, message]));\n          },\n        );\n      },\n      onError: (error) {\n        _logger.e('Error in message stream subscription', error: error);\n      },\n    );\n  }\n}\n```\n\n---\n\n## Event Types Handled\n\n### Timeline Events\n- `m.room.message` - New text, image, video, audio messages\n- `m.room.encrypted` - Encrypted messages (E2EE)\n- `m.room.redaction` - Message deletions\n- `m.reaction` - Emoji reactions\n\n### Ephemeral Events\n- `m.typing` - Typing indicators\n- `m.receipt` - Read receipts\n\n### State Events\n- `m.room.name` - Room name changes\n- `m.room.topic` - Room topic changes\n- `m.room.avatar` - Room avatar changes\n- `m.room.member` - Membership changes\n\n---\n\n## Sync Filter Configuration\n\nThe SDK automatically creates an optimized sync filter:\n\n```dart\nfinal filter = {\n  'room': {\n    'state': {\n      'types': [\n        'm.room.name',\n        'm.room.topic',\n        'm.room.avatar',\n        'm.room.member',\n        'm.room.create',\n        'm.room.join_rules',\n        'm.room.power_levels',\n        'm.room.encryption',\n      ],\n      'lazy_load_members': true,\n    },\n    'timeline': {\n      'limit': 20,\n    },\n    'ephemeral': {\n      'types': ['m.receipt', 'm.typing'],\n    },\n  },\n  'presence': {\n    'types': [],\n  },\n};\n```\n\n**Optimizations:**\n- Lazy loading for room members (reduces bandwidth)\n- Limited timeline events (20 per sync)\n- Specific ephemeral event types\n- No presence events by default\n\n---\n\n## Performance Considerations\n\n### Sync Parameters\n- **Timeout:** 30 seconds (long polling)\n- **Backoff:** 1-60 seconds (exponential)\n- **Timeline Limit:** 20 events per sync\n- **Member Loading:** Lazy loading enabled\n\n### Stream Management\n- **Broadcast Streams:** Multiple listeners supported\n- **Stream Reuse:** Same room returns existing stream\n- **Automatic Cleanup:** Cancellation removes subscription\n- **Error Recovery:** Graceful handling of network issues\n\n### Memory Usage\n- Limited event history (filter)\n- Lazy member loading\n- Stream cleanup on cancellation\n- No duplicate streams per room\n\n---\n\n## Error Handling\n\n### Network Errors\n```dart\nonError: (error) {\n  _logger.e('Error in message stream for room $roomId', error: error);\n  controller.add(Left(ServerFailure(message: error.toString())));\n}\n```\n\n### Client Not Initialized\n```dart\nif (!_matrixClientService.isInitialized) {\n  _logger.w('Matrix client not initialized');\n  controller.add(Left(ServerFailure(message: 'Matrix client not initialized')));\n}\n```\n\n### Stream Cancellation\n```dart\ncontroller.onCancel = () {\n  subscription.cancel();\n  _messageStreams.remove(roomId);\n};\n```\n\n---\n\n## Testing\n\n### Manual Testing Steps\n\n1. **Open Chat Page**\n   - Navigate to a room\n   - Verify `SubscribeToMessages` event is dispatched\n\n2. **Send Message from Another Device**\n   - Use another Matrix client or device\n   - Send a message to the same room\n   - Verify message appears instantly in VoxMatrix\n\n3. **Typing Indicators**\n   - Start typing in another client\n   - Verify typing indicator appears in VoxMatrix\n   - Stop typing and verify indicator disappears\n\n4. **Network Interruption**\n   - Disconnect network\n   - Verify reconnection happens automatically\n   - Verify messages arrive after reconnection\n\n5. **Room Navigation**\n   - Navigate between rooms\n   - Verify streams are properly cleaned up\n   - Verify new room subscriptions work correctly\n\n### Automated Testing (Future)\n\n```dart\n// Example test for message stream\ntest('should emit new messages from sync stream', () async {\n  final repository = MockChatRepository();\n  final useCase = SubscribeToMessagesUseCase(repository);\n  \n  final messages = <MessageEntity>[];\n  repository.getMessagesStream('room1').listen((result) {\n    result.fold(\n      (failure) => fail('Should not fail'),\n      (message) => messages.add(message),\n    );\n  });\n  \n  await Future.delayed(Duration(milliseconds: 100));\n  expect(messages.length, greaterThan(0));\n});\n```\n\n---\n\n## Known Limitations\n\n1. **Typing Users Format**\n   - Returns `List<String>` (user IDs) instead of full user objects\n   - UI must resolve display names separately\n\n2. **Offline Queue**\n   - Not yet implemented\n   - Messages sent while offline may be lost\n\n3. **Message Ordering**\n   - Relies on server ordering\n   - May need client-side deduplication\n\n4. **Stream Cleanup**\n   - Needs testing on rapid room navigation\n   - May require additional cleanup logic\n\n---\n\n## Future Enhancements\n\n1. **Message Deduplication**\n   - Track received event IDs\n   - Prevent duplicate messages\n\n2. **Offline Message Queue**\n   - Queue messages when offline\n   - Send when connection restored\n\n3. **Enhanced Typing Indicators**\n   - Return full user objects\n   - Include display names\n\n4. **Message Receipts**\n   - Read receipt stream\n   - Delivery status tracking\n\n5. **Sync Optimization**\n   - Room-specific sync\n   - Selective event filtering\n\n---\n\n## References\n\n- [Matrix Spec - Sync](https://spec.matrix.org/v1.11/client-server-api/#syncing)\n- [Matrix Spec - Ephemeral Events](https://spec.matrix.org/v1.11/client-server-api/#ephemeral-events)\n- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)\n- [BLoC Pattern](https://bloclibrary.dev)\n\n---\n\n## Changelog\n\n### 2026-02-05\n- \u2705 Initial implementation\n- \u2705 Real-time message streaming\n- \u2705 Typing indicators\n- \u2705 Stream cleanup\n- \u2705 Error handling\n- \u2705 Documentation completed\n\n---\n\n**Author:** AI Assistant  \n**Last Updated:** 2026-02-05  \n**Version:** 1.0.0"]]