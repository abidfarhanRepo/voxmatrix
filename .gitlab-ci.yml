# GitLab CI/CD configuration for VoxMatrix Flutter App

variables:
  FLUTTER_VERSION: "3.24.5"
  JAVA_VERSION: "17"
  GIT_DEPTH: "0"

stages:
  - test
  - build
  - deploy

# Cache configuration
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pub-cache/
    - build/
    - .gradle/
    - ios/Pods/

before_script:
  - export PUB_CACHE=${CI_PROJECT_DIR}/.pub-cache

# Test Jobs
.test-base:
  image: ghcr.io/cirruslabs/flutter:3.24.5
  stage: test
  tags:
    - docker

analyze:
  extends: .test-base
  script:
    - flutter pub get
    - flutter analyze --fatal-infos
    - dart format --output=none --set-exit-if-changed .
  only:
    - merge_requests
    - main
    - develop

test:
  extends: .test-base
  script:
    - flutter pub get
    - flutter test --coverage --test-randomize-ordering-seed random
  coverage: '/lines\.*: \d+\.\d+\%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/lcov.info
    paths:
      - coverage/
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop

security-scan:
  extends: .test-base
  script:
    - flutter pub get
    - dart pub audit
    - flutter pub outdated
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Build Jobs
.build-android-base:
  image: ghcr.io/cirruslabs/flutter:3.24.5
  stage: build
  variables:
    ANDROID_COMPILE_SDK: "34"
    ANDROID_BUILD_TOOLS: "34.0.0"
    ANDROID_SDK_TOOLS: "4383792"
  before_script:
    - export PUB_CACHE=${CI_PROJECT_DIR}/.pub-cache
    - flutter pub get
    - export GRADLE_USER_HOME=${CI_PROJECT_DIR}/.gradle

build-android-debug:
  extends: .build-android-base
  script:
    - flutter build apk --debug --build-number=$CI_PIPELINE_ID
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-debug.apk
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop

build-android-release:
  extends: .build-android-base
  script:
    - flutter build apk --release --build-number=$CI_PIPELINE_ID
    - flutter build appbundle --release --build-number=$CI_PIPELINE_ID
    - cp build/app/outputs/flutter-apk/app-release.apk voxmatrix-${CI_COMMIT_TAG}.apk
    - cp build/app/outputs/bundle/release/app-release.aab voxmatrix-${CI_COMMIT_TAG}.aab
  artifacts:
    paths:
      - voxmatrix-${CI_COMMIT_TAG}.apk
      - voxmatrix-${CI_COMMIT_TAG}.aab
    expire_in: 30 days
  only:
    - tags
  except:
    - branches

.build-ios-base:
  image: macos-14-xcode-15
  stage: build
  tags:
    - macos
  before_script:
    - export PUB_CACHE=${CI_PROJECT_DIR}/.pub-cache
    - flutter pub get
    - cd ios && pod install && cd ..
  cache:
    key: ${CI_COMMIT_REF_SLUG}-ios
    paths:
      - ios/Pods/

build-ios-debug:
  extends: .build-ios-base
  script:
    - flutter build ios --debug --no-codesign --build-number=$CI_PIPELINE_ID
  artifacts:
    paths:
      - build/ios/
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - develop
  allow_failure: true

build-ios-release:
  extends: .build-ios-base
  script:
    - flutter build ios --release --build-number=$CI_PIPELINE_ID
    - cd ios
    - xcodebuild -workspace Runner.xcworkspace
        -scheme Runner
        -sdk iphoneos
        -configuration Release
        -archivePath $CI_PROJECT_DIR/build/Runner.xcarchive
        archive
    - xcodebuild -exportArchive
        -archivePath $CI_PROJECT_DIR/build/Runner.xcarchive
        -exportOptionsPlist ExportOptions.plist
        -exportPath $CI_PROJECT_DIR/build/export
    - cp $CI_PROJECT_DIR/build/export/*.ipa $CI_PROJECT_DIR/voxmatrix-${CI_COMMIT_TAG}.ipa
  artifacts:
    paths:
      - voxmatrix-${CI_COMMIT_TAG}.ipa
    expire_in: 30 days
  only:
    - tags
  except:
    - branches
  allow_failure: true

# Deploy Jobs
deploy-firebase:
  image: node:20
  stage: deploy
  dependencies:
    - build-android-release
  script:
    - npm install -g firebase-tools
    - firebase appdistribution:distribute voxmatrix-${CI_COMMIT_TAG}.apk
        --app $FIREBASE_ANDROID_APP_ID
        --groups "qa-team"
  only:
    - tags
  when: manual

deploy-play-store:
  image: ruby:3.2
  stage: deploy
  dependencies:
    - build-android-release
  before_script:
    - gem install fastlane -NV
  script:
    - cd android
    - echo "$PLAY_STORE_CONFIG" | base64 -d > play-store-credentials.json
    - fastlane supply
        --aab ../voxmatrix-${CI_COMMIT_TAG}.aab
        --track internal
        --json_key play-store-credentials.json
        --package_name com.voxmatrix.app
  only:
    - tags
  when: manual

deploy-testflight:
  image: ruby:3.2
  stage: deploy
  dependencies:
    - build-ios-release
  tags:
    - macos
  before_script:
    - gem install fastlane -NV
    - mkdir -p ~/.appstoreconnect/private_keys
    - echo "$APP_STORE_CONNECT_API_KEY" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8
  script:
    - cd ios
    - fastlane pilot upload
        --ipa ../voxmatrix-${CI_COMMIT_TAG}.ipa
        --skip_waiting_for_build_processing
        --api_key_path ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8
  only:
    - tags
  when: manual

# Release job
release:
  image: alpine:latest
  stage: deploy
  before_script:
    - apk add --no-cache git curl bash
  script:
    - |
      # Generate release notes
      cat > release_notes.md << EOF
      ## VoxMatrix ${CI_COMMIT_TAG}

      ### Changes
      $(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s")

      ### Downloads
      - Android APK: \`voxmatrix-${CI_COMMIT_TAG}.apk\`
      - Android App Bundle: \`voxmatrix-${CI_COMMIT_TAG}.aab\`
      - iOS IPA: \`voxmatrix-${CI_COMMIT_TAG}.ipa\`
      EOF

      # Create GitLab release
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN"
        --data "name=VoxMatrix ${CI_COMMIT_TAG}"
        --data "tag_name=${CI_COMMIT_TAG}"
        --data "@release_notes.md"
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
  only:
    - tags
  when: on_success
