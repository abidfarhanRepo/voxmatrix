name: iOS Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0)'
        required: true
        type: string

env:
  FLUTTER_VERSION: '3.24.5'
  XCODE_VERSION: '15.4'

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Setup Code Signing
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          if [ -n "$IOS_CERTIFICATE_BASE64" ]; then
            CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
            echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH

            security import $CERTIFICATE_PATH \
              -P "$IOS_CERTIFICATE_PASSWORD" \
              -A \
              -t cert \
              -f pkcs12 \
              -k $KEYCHAIN_PATH

            security list-keychain -d user -s $KEYCHAIN_PATH

            # Set provisioning profile
            if [ -n "$IOS_PROVISIONING_PROFILE_BASE64" ]; then
              PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
              mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
              echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > $PROFILE_PATH
              cp $PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
            fi

            echo "CODE_SIGNING_ENABLED=true" >> $GITHUB_ENV
            echo "CODE_SIGNING_REQUIRED=true" >> $GITHUB_ENV
          else
            echo "Warning: iOS code signing certificates not configured"
            echo "CODE_SIGNING_ENABLED=false" >> $GITHUB_ENV
            echo "CODE_SIGNING_REQUIRED=false" >> $GITHUB_ENV
          fi

      - name: Build Release IPA (no codesign)
        if: env.CODE_SIGNING_ENABLED != 'true'
        run: |
          flutter build ios --release --no-codesign \
            --build-number=${{ github.run_number }}

      - name: Build Release IPA (with codesign)
        if: env.CODE_SIGNING_ENABLED == 'true'
        run: |
          flutter build ios --release --build-number=${{ github.run_number }}

          # Build archive and export IPA
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Runner.xcarchive \
            archive

          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Runner.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $RUNNER_TEMP/build

      - name: Create IPA from Archive
        if: env.CODE_SIGNING_ENABLED == 'true'
        run: |
          if [ -d "$RUNNER_TEMP/build" ]; then
            find $RUNNER_TEMP/build -name "*.ipa" -exec cp {} voxmatrix-${{ github.ref_name }}.ipa \;
          fi

      - name: Create mock IPA (no codesign)
        if: env.CODE_SIGNING_ENABLED != 'true'
        run: |
          # Create a placeholder for workflow consistency
          mkdir -p build/ios/iphoneos
          echo "iOS build completed (unsigned)" > voxmatrix-${{ github.ref_name }}-unsigned.txt

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-ipa
          path: |
            voxmatrix-${{ github.ref_name }}.ipa
            voxmatrix-${{ github.ref_name }}-unsigned.txt
          retention-days: 30

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            ~/Library/Logs/
            build/ios/logs/
          retention-days: 7

  upload-testflight:
    name: Upload to TestFlight
    runs-on: macos-14
    needs: build-ios
    if: env.CODE_SIGNING_ENABLED == 'true'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-release-ipa
          path: ./artifacts

      - name: Install Fastlane
        run: |
          cd ios
          gem install fastlane -NV

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          if [ -f artifacts/voxmatrix-${{ github.ref_name }}.ipa ]; then
            cd ios

            # Create API key file
            mkdir -p ~/.appstoreconnect/private_keys
            echo "$APP_STORE_CONNECT_API_KEY_CONTENT" | base64 --decode > \
              ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

            # Upload to TestFlight
            fastlane pilot upload \
              --ipa artifacts/voxmatrix-${{ github.ref_name }}.ipa \
              --skip_waiting_for_build_processing \
              --api_key_path ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8
          else
            echo "No IPA file found"
          fi
